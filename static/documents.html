<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; max-width: 900px; margin: 40px auto; padding: 0 20px; }
        h1, h2 { color: #2c3e50; }
        .nav { margin-bottom: 20px; }
        .nav a { color: #3498db; text-decoration: none; }
        .upload-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #dee2e6; }
        input[type="file"] { margin: 10px 0; }
        button { background: #3498db; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; }
        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #dee2e6; }
        th { background-color: #f2f2f2; }
        .status { margin-top: 10px; font-weight: bold; }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
    </style>
</head>
<body>
    <div class="nav">
        <a href="/">‚Üê –ù–∞–∑–∞–¥ –∫ –ø–æ–∏—Å–∫—É</a>
    </div>

    <h1>üìÑ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏</h1>

    <div class="upload-section">
        <h2>–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã</h2>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã (PDF, TXT, MD) –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.</p>
        <input type="file" id="fileInput" multiple accept=".pdf,.txt,.md">
        <br>
        <button id="uploadBtn" onclick="uploadFiles()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã</button>
        <div id="uploadStatus" class="status"></div>
    </div>

    <h2>–°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h2>
    <div id="loadingDocs">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</div>
    <table id="docsTable" style="display:none;">
        <thead>
            <tr>
                <th>–ò–º—è —Ñ–∞–π–ª–∞</th>
                <th>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏</th>
                <th>–†–∞–∑–º–µ—Ä</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="docsList"></tbody>
    </table>

    <div id="pagination" style="margin-top: 20px; display: none; align-items: center; gap: 15px;">
        <button id="prevBtn" onclick="changePage(-1)">‚Üê –ù–∞–∑–∞–¥</button>
        <span id="pageInfo">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 1</span>
        <button id="nextBtn" onclick="changePage(1)">–í–ø–µ—Ä–µ–¥ ‚Üí</button>
    </div>

    <script>
        let currentPage = 1;
        const pageSize = 10;

        async function loadDocuments(page = 1) {
            currentPage = page;
            const loadingDiv = document.getElementById("loadingDocs");
            const table = document.getElementById("docsTable");
            const list = document.getElementById("docsList");
            const pagination = document.getElementById("pagination");

            try {
                const res = await fetch(`/api/v1/documents?page=${page}&size=${pageSize}`);
                const data = await res.json();

                if (!res.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫");

                list.innerHTML = "";
                if (data.items.length === 0) {
                    loadingDiv.innerText = "–î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.";
                    loadingDiv.style.display = "block";
                    table.style.display = "none";
                    pagination.style.display = "none";
                    return;
                }

                data.items.forEach(doc => {
                    const row = document.createElement("tr");
                    const date = new Date(doc.upload_date).toLocaleString('ru-RU');
                    const size = (doc.size / 1024).toFixed(1) + " KB";
                    
                    row.innerHTML = `
                        <td><a href="/docs_files/${doc.name}" target="_blank">${doc.name}</a></td>
                        <td>${date}</td>
                        <td>${size}</td>
                        <td>
                            <button onclick="deleteDocument('${doc.name}')" style="background: #e74c3c; padding: 5px 10px; font-size: 0.8em;">–£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    `;
                    list.appendChild(row);
                });

                loadingDiv.style.display = "none";
                table.style.display = "table";
                
                // Pagination info
                if (data.pages > 1) {
                    pagination.style.display = "flex";
                    document.getElementById("pageInfo").innerText = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${data.page} –∏–∑ ${data.pages}`;
                    document.getElementById("prevBtn").disabled = data.page <= 1;
                    document.getElementById("nextBtn").disabled = data.page >= data.pages;
                } else {
                    pagination.style.display = "none";
                }

            } catch (e) {
                loadingDiv.innerHTML = `<span class="error">–û—à–∏–±–∫–∞: ${e.message}</span>`;
            }
        }

        function changePage(delta) {
            loadDocuments(currentPage + delta);
        }

        async function deleteDocument(filename) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª "${filename}"?`)) return;

            try {
                const res = await fetch(`/api/v1/documents/${filename}`, {
                    method: "DELETE"
                });
                const data = await res.json();
                
                if (res.ok) {
                    loadDocuments(currentPage);
                } else {
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: " + (data.detail || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                }
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: " + e.message);
            }
        }

        async function uploadFiles() {
            const input = document.getElementById("fileInput");
            const btn = document.getElementById("uploadBtn");
            const status = document.getElementById("uploadStatus");

            if (input.files.length === 0) {
                status.innerHTML = '<span class="error">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª</span>';
                return;
            }

            const formData = new FormData();
            for (let i = 0; i < input.files.length; i++) {
                formData.append("files", input.files[i]);
            }

            btn.disabled = true;
            status.innerHTML = "<em>–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è.</em>";
            status.className = "status";

            try {
                const res = await fetch("/api/v1/documents", {
                    method: "POST",
                    body: formData
                });

                const data = await res.json();

                if (!res.ok) throw new Error(data.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ");

                status.innerHTML = `<span class="success">–£—Å–ø–µ—à–Ω–æ! –î–æ–±–∞–≤–ª–µ–Ω–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤: ${data.added_chunks}. –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${data.processed_files.length}</span>`;
                input.value = "";
                loadDocuments();
            } catch (e) {
                status.innerHTML = `<span class="error">–û—à–∏–±–∫–∞: ${e.message}</span>`;
            } finally {
                btn.disabled = false;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadDocuments();
    </script>
</body>
</html>
